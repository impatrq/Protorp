import network, time, random
from machine import Pin
from umqttsimple import MQTTClient

rx = Pin(1, Pin.IN)


sta_if = network.WLAN(network.STA_IF)
sta_if.active(True)
sta_if.connect("Cooperadora Profesores", "Profes_IMPA_2022")A
while not sta_if.isconnected():
    time.sleep(0.5)


client = MQTTClient("esp32", "broker.hivemq.com")
client.connect()

def estado_semaforo():
    return "seguir" if rx.value() == 1 else "reducir"

while True:
    velocidad = random.randint(0, 120)
    voltaje = random.randint(160, 220)
    estado = estado_semaforo()
    mensaje = '{{"velocidad":{},"voltaje":{},"estado_semaforo":"{}"}}'.format(velocidad, voltaje, estado)
    client.publish(b"protorp/tren", mensaje)
    print("Publicado:", mensaje)
    time.sleep(5)
